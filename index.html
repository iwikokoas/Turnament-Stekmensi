<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PES World Cup â€“ STEKMENSI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bg:#0b1020;--card:#121832;--muted:#94a3b8;--ring:#3b82f6}
    html,body{background:linear-gradient(180deg,#0b1020,#0f1630 40%,#0b1020);color:white;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);backdrop-filter: blur(10px)}
    input[type=number]{background:#0c1227;border:1px solid rgba(255,255,255,0.08);border-radius:.5rem;padding:.4rem .5rem;width:4.2rem}
    input[type=number]:focus{outline:none;border-color:var(--ring);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .badge{background:#0c1227;border:1px solid rgba(255,255,255,.08);border-radius:.4rem;padding:.15rem .45rem}
    .tab-active{background:#1b2448}
    .table th,.table td{padding:.55rem .6rem;border-bottom:1px dashed rgba(255,255,255,.06)}
    .locked .score{opacity:.6;pointer-events:none}
    .lock-badge{font-size:.75rem;opacity:.8}
  </style>
</head>
<body class="min-h-screen">
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-4">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-5">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">PES World Cup STEKMENSI</h1>
        <p class="text-slate-300 mt-2">Format: penyisihan grup sistem saling bertemu (roundâ€‘robin). </p>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnEnterAdmin" class="px-4 py-2 rounded-xl card">Masuk Admin</button>
        <!-- Tombol Reset hanya untuk admin -->
        <button id="btnReset" class="px-4 py-2 rounded-xl card" style="display:none;">Reset Semua</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-16">
    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-4" id="tabs"></div>

    <!-- Groups container -->
    <div id="groups" class="grid gap-6"></div>

    <!-- Top 2 per group summary -->
    <section class="mt-10">
      <div class="card rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Ringkasan Pemuncak Grup (Top 2)</h2>
          <span class="text-xs text-slate-400">Tieâ€‘breakers: Pts â†’ GD â†’ GF â†’ Headâ€‘toâ€‘Head â†’ Nama</span>
        </div>
        <div id="summary" class="grid md:grid-cols-2 gap-4"></div>
      </div>
    </section>
  </main>

  <template id="groupTemplate">
    <section class="card rounded-2xl p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold">Grup <span class="grp-name"></span></h3>
        <div class="text-sm text-slate-300">Total Pertandingan: <span class="total-matches"></span></div>
      </div>
      <div class="mt-4 grid lg:grid-cols-2 gap-6">
        <div>
          <h4 class="font-semibold mb-2">Jadwal & Input Skor</h4>
          <div class="space-y-2 matches"></div>
        </div>
        <div>
          <h4 class="font-semibold mb-2">Klasemen</h4>
          <div class="overflow-x-auto">
            <table class="table w-full text-sm">
              <thead class="text-slate-300">
                <tr>
                  <th class="text-left">Tim</th>
                  <th>P</th>
                  <th>W</th>
                  <th>D</th>
                  <th>L</th>
                  <th>GF</th>
                  <th>GA</th>
                  <th>GD</th>
                  <th>Pts</th>
                </tr>
              </thead>
              <tbody class="standings"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </template>

  <template id="matchTemplate">
    <div class="rounded-xl p-3 card flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 min-w-0">
        <span class="badge text-xs shrink-0">MD<span class="md-no"></span></span>
        <div class="truncate">
          <div class="font-semibold text-sm home"></div>
          <div class="text-slate-400 text-xs">vs</div>
          <div class="font-semibold text-sm away"></div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <input type="number" min="0" inputmode="numeric" class="score home-score" placeholder="0" />
        <span class="text-slate-400">â€“</span>
        <input type="number" min="0" inputmode="numeric" class="score away-score" placeholder="0" />
      </div>
    </div>
  </template>

  <script>
    // ======= DATA =======
    const GROUPS = {
      A: [
        { name: 'NK', team: 'Italia ğŸ‡®ğŸ‡¹' },
        { name: 'Opik', team: 'Norwegia ğŸ‡³ğŸ‡´' },
        { name: 'Ud', team: 'Belgia ğŸ‡§ğŸ‡ª' },
      ],
      B: [
        { name: 'Rido', team: 'Portugal ğŸ‡µğŸ‡¹' },
        { name: 'Nuryana', team: 'England ğŸ´' }, // <--- perbaikan di sini
        { name: 'Wahyu', team: 'Uruguay ğŸ‡ºğŸ‡¾' },
      ],
      C: [
        { name: 'AMF', team: 'Belanda ğŸ‡³ğŸ‡±' },    // Netherland -> Belanda
        { name: 'Ule', team: 'Argentina ğŸ‡¦ğŸ‡·' },
        { name: 'Andri', team: 'Brazil ğŸ‡§ğŸ‡·' },
      ],
      D: [
        { name: 'Eeng', team: 'Prancis ğŸ‡«ğŸ‡·' },   // Francis -> Prancis
        { name: 'Dinar', team: 'Spanyol ğŸ‡ªğŸ‡¸' },  // Spain -> Spanyol
        { name: 'Mulanda', team: 'Jerman ğŸ‡©ğŸ‡ª' },
      ],
    };

    // ======= STORAGE, SHARE & ADMIN =======
    const STORAGE_KEY = 'pes_wc_scores_v2';
    const ADMIN_KEY = 'pes_wc_admin_token_v2';

    function genToken(len=24){
      const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let s='';
      if (window.crypto && window.crypto.getRandomValues) {
        window.crypto.getRandomValues(new Uint8Array(len)).forEach(v=> s+=chars[v%chars.length]);
      } else {
        // Fallback untuk lingkungan non-browser
        for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
      }
      return s;
    }

    function getURLToken(){
      const u = new URL(location.href);
      return u.searchParams.get('admin');
    }

    function setURLToken(tok){
      const u = new URL(location.href);
      if(tok) u.searchParams.set('admin', tok); else u.searchParams.delete('admin');
      // Hapus password dari bar browser setelah validasi
      history.replaceState(null,'',u.origin + u.pathname + u.hash);
    }

    function saveState(state){
      // Save scores only (no admin token) to localStorage and URL hash
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      const shareObj = { scores: state.scores };
      const h = '#' + encodeURIComponent(JSON.stringify(shareObj));
      const u = new URL(location.href);
      u.hash = h;
      history.replaceState(null, '', u.toString());
    }
    function loadState(){
      // prefer hash, else localStorage
      try{
        if(location.hash?.length>1){
          const obj = JSON.parse(decodeURIComponent(location.hash.slice(1)));
          if(obj && typeof obj==='object') return { scores: obj.scores || {} };
        }
      }catch(e){/* ignore */}
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){return null}
    }

    function ensureAdminToken(){
      let tok = localStorage.getItem(ADMIN_KEY);
      if(!tok){ tok = genToken(); localStorage.setItem(ADMIN_KEY, tok); }
      return tok;
    }

    function hasAdmin() {
      const localTok = localStorage.getItem(ADMIN_KEY);
      const urlTok = getURLToken();
      // Jika token ada di URL, simpan ke localStorage sehingga persist setelah reload,
      // lalu hapus token dari URL untuk keamanan.
      if (urlTok) {
        localStorage.setItem(ADMIN_KEY, urlTok);
        // Hapus token dari URL agar tidak terlihat di address bar
        setURLToken(null);
        return true;
      }
      // Jika tidak ada token di URL, cukup cek localStorage
      return !!localTok;
    }

    // ======= TIEBREAKERS =======
    function h2hRank(records, fixtures){
      const ids = records.map(r=>r.id);
      const idx = new Map(ids.map((id,i)=>[id,i]));
      const mini = ids.map(()=>({P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,PTS:0}));
      for(const m of fixtures){
        const a = idx.get(m.homeId), b = idx.get(m.awayId);
        if(a===undefined || b===undefined) continue;
        const hs = m.hs, as = m.as;
        if(hs==null || as==null) continue;
        mini[a].P++; mini[b].P++;
        mini[a].GF+=hs; mini[a].GA+=as; mini[a].GD=mini[a].GF-mini[a].GA;
        mini[b].GF+=as; mini[b].GA+=hs; mini[b].GD=mini[b].GF-mini[b].GA;
        if(hs>as){mini[a].W++;mini[b].L++; mini[a].PTS+=3}
        else if(hs<as){mini[b].W++;mini[a].L++; mini[b].PTS+=3}
        else {mini[a].D++;mini[b].D++; mini[a].PTS++; mini[b].PTS++}
      }
      const arr = records.map((r,i)=>({r, m:mini[i]}));
      arr.sort((x,y)=> y.m.PTS - x.m.PTS || y.m.GD - x.m.GD || y.m.GF - x.r.name.localeCompare(y.r.name));
      return arr.map(x=>x.r.id);
    }

    function rankTeams(teams, results){
      const stats = new Map(teams.map(t=>[t.id,{P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,PTS:0}]));
      for(const m of results){
        if(m.hs==null || m.as==null) continue;
        const a = stats.get(m.homeId), b = stats.get(m.awayId);
        a.P++; b.P++;
        a.GF+=m.hs; a.GA+=m.as; a.GD=a.GF-a.GA;
        b.GF+=m.as; b.GA+=m.hs; b.GD=b.GF-b.GA;
        if(m.hs>m.as){a.W++; b.L++; a.PTS+=3}
        else if(m.hs<m.as){b.W++; a.L++; b.PTS+=3}
        else {a.D++; b.D++; a.PTS++; b.PTS++}
      }
      const base = teams.map(t=>({id:t.id, name:t.name, s:stats.get(t.id)}));
      base.sort((x,y)=> y.s.PTS - x.s.PTS || y.s.GD - x.s.GD || y.s.GF - x.s.GF || 0);
      let i=0; while(i<base.length){
        let j=i+1; while(j<base.length && base[j].s.PTS===base[i].s.PTS && base[j].s.GD===base[i].s.GD && base[j].s.GF===base[i].s.GF) j++;
        if(j-i>1){
          const block = base.slice(i,j);
          const orderIds = h2hRank(block, results);
          block.sort((a,b)=> orderIds.indexOf(a.id) - orderIds.indexOf(b.id));
          base.splice(i, j-i, ...block);
        }
        i=j;
      }
      return base;
    }

    // ======= UI RENDER =======
    const tabsEl = document.getElementById('tabs');
    const groupsEl = document.getElementById('groups');
    const summaryEl = document.getElementById('summary');

    // Jika tidak ada state di hash/localStorage, pakai contoh data supaya viewer biasa bisa melihat skor
    const DEFAULT_SCORES = {
      // Grup A (NK, Opik, Ud)
      'A-0-1': { hs: 2, as: 1, homeId: 'A-0', awayId: 'A-1' },
      'A-1-0': { hs: 1, as: 1, homeId: 'A-1', awayId: 'A-0' },
      'A-0-2': { hs: 3, as: 0, homeId: 'A-0', awayId: 'A-2' },
      'A-2-0': { hs: 0, as: 2, homeId: 'A-2', awayId: 'A-0' },
      'A-1-2': { hs: 1, as: 2, homeId: 'A-1', awayId: 'A-2' },
      'A-2-1': { hs: 0, as: 0, homeId: 'A-2', awayId: 'A-1' },
      // Grup B (Rido, Nuryana, Wahyu)
      'B-0-1': { hs: 1, as: 0, homeId: 'B-0', awayId: 'B-1' },
      'B-1-0': { hs: 0, as: 2, homeId: 'B-1', awayId: 'B-0' },
      'B-0-2': { hs: 2, as: 2, homeId: 'B-0', awayId: 'B-2' },
      'B-2-0': { hs: 1, as: 3, homeId: 'B-2', awayId: 'B-0' },
      'B-1-2': { hs: 0, as: 1, homeId: 'B-1', awayId: 'B-2' },
      'B-2-1': { hs: 2, as: 0, homeId: 'B-2', awayId: 'B-1' },
      // Grup C (AMF, Ule, Andri)
      'C-0-1': { hs: 0, as: 1, homeId: 'C-0', awayId: 'C-1' },
      'C-1-0': { hs: 1, as: 1, homeId: 'C-1', awayId: 'C-0' },
      'C-0-2': { hs: 2, as: 0, homeId: 'C-0', awayId: 'C-2' },
      'C-2-0': { hs: 0, as: 2, homeId: 'C-2', awayId: 'C-0' },
      'C-1-2': { hs: 0, as: 3, homeId: 'C-1', awayId: 'C-2' },
      'C-2-1': { hs: 1, as: 0, homeId: 'C-2', awayId: 'C-1' },
      // Grup D (Eeng, Dinar, Mulanda)
      'D-0-1': { hs: 2, as: 2, homeId: 'D-0', awayId: 'D-1' },
      'D-1-0': { hs: 0, as: 1, homeId: 'D-1', awayId: 'D-0' },
      'D-0-2': { hs: 1, as: 1, homeId: 'D-0', awayId: 'D-2' },
      'D-2-0': { hs: 0, as: 2, homeId: 'D-2', awayId: 'D-0' },
      'D-1-2': { hs: 3, as: 1, homeId: 'D-1', awayId: 'D-2' },
      'D-2-1': { hs: 0, as: 0, homeId: 'D-2', awayId: 'D-1' },
    };
    const state = loadState() || { scores: DEFAULT_SCORES };

    const groups = {};

    function makeTeamLabel(p){
      // Pisahkan bendera dari nama tim jika ada
      const match = p.team.match(/(.*?)([\u{1F1E6}-\u{1F1FF}]{2,}|ğŸ´)?$/u);
      let teamName = match ? match[1].trim() : p.team;
      let flag = match ? match[2] || '' : '';
      return `${capitalizeWords(p.name)} â€” ${capitalizeWords(teamName)} ${flag}`.trim();
    }

    function buildFixtures(arr){
      // Home-away round robin (6 matches)
      return [
        [0,1,true], [1,0,true],
        [0,2,true], [2,0,true],
        [1,2,true], [2,1,true]
      ];
    }

    function render(){
      tabsEl.innerHTML = '';
      groupsEl.innerHTML = '';
      summaryEl.innerHTML = '';

      const isAdmin = hasAdmin();

      // Tampilkan tombol reset hanya untuk admin
      document.getElementById('btnReset').style.display = isAdmin ? '' : 'none';

      Object.entries(GROUPS).forEach(([grp, players], idx)=>{
        // Tabs
        const tab = document.createElement('button');
        tab.className = `px-3 py-2 rounded-xl card text-sm ${idx===0? 'tab-active':''}`;
        tab.textContent = `Grup ${grp}`;
        tab.addEventListener('click',()=>{
          document.querySelectorAll('#tabs > button').forEach(b=>b.classList.remove('tab-active'));
          tab.classList.add('tab-active');
          document.querySelectorAll('[data-group]')
            .forEach(sec=>sec.classList.toggle('hidden', sec.getAttribute('data-group')!==grp));
        });
        tabsEl.appendChild(tab);

        // Section
        const gtpl = document.getElementById('groupTemplate');
        const node = gtpl.content.cloneNode(true);
        const section = node.querySelector('section');
        section.setAttribute('data-group', grp);
        if(idx!==0) section.classList.add('hidden');
        section.querySelector('.grp-name').textContent = grp;

        if(!isAdmin){
          const lb = document.createElement('div');
          lb.className = 'lock-badge text-slate-300 mb-2';
          lb.innerHTML = 'ğŸ”’ mode viewer Â· hanya admin yang bisa input skor';
          section.prepend(lb);
          section.classList.add('locked');
        }

        // Build team objects w/ ids
        const teams = players.map((p,i)=>({ id:`${grp}-${i}`, name: makeTeamLabel(p) }));
        const nameById = Object.fromEntries(teams.map(t=>[t.id,t.name]));

        // Matches
        const matchesWrap = section.querySelector('.matches');
        const mtpl = document.getElementById('matchTemplate');
        const pairs = buildFixtures(players);
        section.querySelector('.total-matches').textContent = pairs.length;

        pairs.forEach((pair, i)=>{
          const [a,b] = pair;
          const mnode = mtpl.content.cloneNode(true);
          mnode.querySelector('.md-no').textContent = (i+1);
          const k = keyFor(grp,a,b);
          const hsInput = mnode.querySelector('.home-score');
          const asInput = mnode.querySelector('.away-score');
          const swapBtn = mnode.querySelector('.swap-btn');

          // Home/away mapping
          const homeId = `${grp}-${a}`;
          const awayId = `${grp}-${b}`;
          const saved = state.scores[k] || null;

          mnode.querySelector('.home').textContent = nameById[homeId];
          mnode.querySelector('.away').textContent = nameById[awayId];
          if(saved){
            if(saved.hs!=null) hsInput.value = saved.hs;
            if(saved.as!=null) asInput.value = saved.as;
          }

          function persistFromInputs(){
            const hs = hsInput.value===''? null : parseInt(hsInput.value,10);
            const as = asInput.value===''? null : parseInt(asInput.value,10);
            state.scores[k] = { hs, as, homeId, awayId };
            saveState(state);
            updateStandings();
          }

          hsInput.addEventListener('input', persistFromInputs);
          asInput.addEventListener('input', persistFromInputs);

          if(!isAdmin){
            hsInput.disabled = true; asInput.disabled = true; swapBtn.style.display = 'none';
          }

          matchesWrap.appendChild(mnode);
        });

        const tbody = section.querySelector('.standings');
        function drawStandings(){
          const rows = rankTeams(teams, collectResultsForGroup(grp));
          tbody.innerHTML='';
          rows.forEach(r=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="text-left">${r.name}</td>
              <td class="text-center">${r.s.P}</td>
              <td class="text-center">${r.s.W}</td>
              <td class="text-center">${r.s.D}</td>
              <td class="text-center">${r.s.L}</td>
              <td class="text-center">${r.s.GF}</td>
              <td class="text-center">${r.s.GA}</td>
              <td class="text-center">${r.s.GD}</td>
              <td class="text-center font-semibold">${r.s.PTS}</td>
            `;
            tbody.appendChild(tr);
          })
        }
        groups[grp] = { drawStandings, teams };

        groupsEl.appendChild(node);
      });

      updateStandings();
    }

    function keyFor(grp,a,b){return `${grp}-${a}-${b}`}

    function collectResultsForGroup(grp){
      const players = GROUPS[grp];
      const pairs = buildFixtures(players);
      const out=[];
      pairs.forEach(([a,b])=>{
        const k = keyFor(grp,a,b);
        const saved = state.scores[k] || null;
        const homeId = `${grp}-${a}`;
        const awayId = `${grp}-${b}`;
        out.push({ homeId, awayId, hs: saved?.hs ?? null, as: saved?.as ?? null });
      });
      return out;
    }
    //
    function updateStandings(){
      Object.keys(GROUPS).forEach(grp=>{ groups[grp]?.drawStandings(); });
      summaryEl.innerHTML='';
      Object.entries(groups).forEach(([grp, g])=>{
        const rows = rankTeams(g.teams, collectResultsForGroup(grp));
        const top = rows.slice(0,2);
        const div = document.createElement('div');
        div.className = 'rounded-xl p-4 card';
        div.innerHTML = `
          <div class=\"flex items-center justify-between mb-2\">
            <div class=\"font-semibold\">Grup ${grp}</div>
            <div class=\"text-xs text-slate-400\">${rows.reduce((p,c)=>p+(c.s.PTS||0),0)} total pts</div>
          </div>
          <ol class=\"space-y-1 text-sm\">
            ${top.map((t,i)=>`<li class=\"flex items-center justify-between\"><span>${i+1}. ${t.name}</span><span class=\"badge\">${t.s.PTS} pts | GD ${t.s.GD}</span></li>`).join('')}
          </ol>`;
        summaryEl.appendChild(div);
      });
    }

    // ======= Buttons =======
    document.getElementById('btnEnterAdmin').addEventListener('click',()=>{
      const v = prompt('Masukkan token admin (dari link admin):');
      if(!v) return;
      localStorage.setItem(ADMIN_KEY, v.trim());
      // pastikan token tidak ditampilkan di URL
      setURLToken(null);
      toast('Admin mode diaktifkan');
      location.reload();
    });

    document.getElementById('btnReset').addEventListener('click',()=>{
      if(!confirm('Hapus semua skor?')) return;
      state.scores = {};
      saveState(state);
      location.reload();
    });

    function toast(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      el.className = 'fixed left-1/2 -translate-x-1/2 bottom-6 px-4 py-2 rounded-xl card text-sm';
      document.body.appendChild(el);
      setTimeout(()=>{el.remove()}, 2200);
    }

    function capitalizeWords(str) {
      return str.replace(/\b\w/g, l => l.toUpperCase());
    }

    (function init(){
      // Jika ada token di URL, hasAdmin() akan menyimpannya ke localStorage.
      render();
    })();
  </script>
</body>
</html>
