<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PES World Cup â€“ STEKMENSI</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Twemoji to ensure flags render consistently across devices -->
  <script src="https://cdn.jsdelivr.net/npm/twemoji@14.0.2/dist/twemoji.min.js"></script>
  <!-- Optional: Firebase for shared public storage (only used if configured) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <!-- Optional: Supabase for shared public storage (preferred if configured) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>
  <script>
    // Supabase config (provided by user)
    window.SUPABASE_URL = "https://jkjhpagjllrvyhuqgcek.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpramhwYWdqbGxydnlodXFnY2VrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MDMxNDEsImV4cCI6MjA3MjQ3OTE0MX0.FmGs0c_GW7LnPXa7_bYoNnVQhoinYtotW79iZLRBJBM";
  </script>
  <script>
    // Firebase config injected per user request. Edit if your project uses different domains/IDs.
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyAhlrWbJ1vTW4ImuXyg19zt71n8B-IslIc",
      databaseURL: "https://pes-world-cup-default-rtdb.asia-southeast1.firebasedatabase.app/",
      // The following are optional for Realtime Database usage without Auth. Adjust if needed.
      authDomain: "pes-world-cup.firebaseapp.com",
      projectId: "pes-world-cup"
    };
  </script>
  <style>
    :root{--bg:#0b1020;--card:#121832;--muted:#94a3b8;--ring:#3b82f6}
    html,body{background:linear-gradient(180deg,#0b1020,#0f1630 40%,#0b1020);color:white;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);backdrop-filter: blur(10px)}
    input[type=number]{background:#0c1227;border:1px solid rgba(255,255,255,0.08);border-radius:.5rem;padding:.4rem .5rem;width:4.2rem}
    input[type=number]:focus{outline:none;border-color:var(--ring);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .badge{background:#0c1227;border:1px solid rgba(255,255,255,.08);border-radius:.4rem;padding:.15rem .45rem}
    .tab-active{background:#1b2448}
    .table th,.table td{padding:.55rem .6rem;border-bottom:1px dashed rgba(255,255,255,.06)}
    .locked .score{opacity:.6;pointer-events:none}
    .lock-badge{font-size:.75rem;opacity:.8}
    /* Style for twemoji images to align with text */
    .emoji{height:1em;width:1em;margin:0 .1em;vertical-align:-0.15em;display:inline-block}
    .home,.away{white-space:nowrap}
  </style>
</head>
<body class="min-h-screen">
  <header class="max-w-6xl mx-auto px-4 pt-8 pb-4">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-5">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">PES World Cup STEKMENSI</h1>
        <p class="text-slate-300 mt-2">Format: penyisihan grup sistem saling bertemu (roundâ€‘robin). </p>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="btnEnterAdmin" class="px-4 py-2 rounded-xl card">Masuk Admin</button>
        <!-- Tombol Reset hanya untuk admin -->
        <button id="btnReset" class="px-4 py-2 rounded-xl card" style="display:none;">Reset Semua</button>
        <button id="btnExitAdmin" class="px-4 py-2 rounded-xl card" style="display:none;">Keluar Admin</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-16">
    <!-- Tabs -->
    <div class="flex flex-wrap gap-2 mb-4" id="tabs"></div>

    <!-- Groups container -->
    <div id="groups" class="grid gap-6"></div>

    <!-- Top 2 per group summary -->
    <section class="mt-10">
      <div class="card rounded-2xl p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Ringkasan Pemuncak Grup (Top 2)</h2>
          <span class="text-xs text-slate-400">Tieâ€‘breakers: Pts â†’ GD â†’ GF â†’ Headâ€‘toâ€‘Head â†’ Nama</span>
        </div>
        <div id="summary" class="grid md:grid-cols-2 gap-4"></div>
      </div>
    </section>
  </main>

  <template id="groupTemplate">
    <section class="card rounded-2xl p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold">Grup <span class="grp-name"></span></h3>
        <div class="text-sm text-slate-300">Total Pertandingan: <span class="total-matches"></span></div>
      </div>
      <div class="mt-4 grid lg:grid-cols-2 gap-6">
        <div>
          <h4 class="font-semibold mb-2">Jadwal & Input Skor</h4>
          <div class="space-y-2 matches"></div>
        </div>
        <div>
          <h4 class="font-semibold mb-2">Klasemen</h4>
          <div class="overflow-x-auto">
            <table class="table w-full text-sm">
              <thead class="text-slate-300">
                <tr>
                  <th class="text-left">Tim</th>
                  <th>P</th>
                  <th>W</th>
                  <th>D</th>
                  <th>L</th>
                  <th>GF</th>
                  <th>GA</th>
                  <th>GD</th>
                  <th>Pts</th>
                </tr>
              </thead>
              <tbody class="standings"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </template>

  <template id="matchTemplate">
    <div class="rounded-xl p-3 card flex items-center justify-between gap-3">
      <div class="flex items-center gap-2 min-w-0">
        <span class="badge text-xs shrink-0">MD<span class="md-no"></span></span>
        <div class="truncate">
          <div class="font-semibold text-sm home"></div>
          <div class="text-slate-400 text-xs">vs</div>
          <div class="font-semibold text-sm away"></div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <input type="number" min="0" inputmode="numeric" class="score home-score" placeholder="0" />
        <span class="text-slate-400">â€“</span>
        <input type="number" min="0" inputmode="numeric" class="score away-score" placeholder="0" />
      </div>
    </div>
  </template>

  <script>
    // ======= DATA =======
    const GROUPS = {
      A: [
        { name: 'NK', team: 'Italia ðŸ‡®ðŸ‡¹' },
        { name: 'Opik', team: 'Norwegia ðŸ‡³ðŸ‡´' },
        { name: 'Ud', team: 'Belgia ðŸ‡§ðŸ‡ª' },
      ],
      B: [
        { name: 'Rido', team: 'Portugal ðŸ‡µðŸ‡¹' },
        { name: 'Nuryana', team: 'Inggris ðŸ‡¬ðŸ‡§' }, // <--- perbaikan di sini
        { name: 'Wahyu', team: 'Uruguay ðŸ‡ºðŸ‡¾' },
      ],
      C: [
        { name: 'AMF', team: 'Belanda ðŸ‡³ðŸ‡±' },    // Netherland -> Belanda
        { name: 'Ule', team: 'Argentina ðŸ‡¦ðŸ‡·' },
        { name: 'Andri', team: 'Brasil ðŸ‡§ðŸ‡·' },
      ],
      D: [
        { name: 'Eeng', team: 'Prancis ðŸ‡«ðŸ‡·' },   // Francis -> Prancis
        { name: 'Dinar', team: 'Spanyol ðŸ‡ªðŸ‡¸' },  // Spain -> Spanyol
        { name: 'Mulanda', team: 'Jerman ðŸ‡©ðŸ‡ª' },
      ],
    };

    // ======= STORAGE, SHARE & ADMIN =======
    // Untuk menyimpan data agar bisa dilihat semua orang, siapkan Firebase config berikut di atas script ini:
    // window.FIREBASE_CONFIG = { apiKey: "...", authDomain: "...", databaseURL: "https://<project>.firebaseio.com", projectId: "...", storageBucket: "...", messagingSenderId: "...", appId: "..." };
    // Jika tidak diisi, aplikasi otomatis kembali ke penyimpanan lokal (hanya browser sendiri).
    const STORAGE_KEY = 'pes_wc_scores_v2';
    const ADMIN_KEY = 'pes_wc_admin_token_v2';
    const ADMIN_PASSWORD = '123';
    // Remote via Supabase (preferred) or Firebase
    let SUPABASE = null;
    let SUPABASE_ENABLED = false;
    let SUPABASE_CHANNEL = null;
    let REMOTE_DB = null; // firebase path
    let REMOTE_ENABLED = false; // firebase enabled
    let lastRemoteJson = '';
    let lastLocalSaveAt = 0;
    let saveTimer = null;

    function genToken(len=24){
      const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let s='';
      if (window.crypto && window.crypto.getRandomValues) {
        window.crypto.getRandomValues(new Uint8Array(len)).forEach(v=> s+=chars[v%chars.length]);
      } else {
        // Fallback untuk lingkungan non-browser
        for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
      }
      return s;
    }

    function getURLToken(){
      const u = new URL(location.href);
      return u.searchParams.get('admin');
    }

    function setURLToken(tok){
      const u = new URL(location.href);
      if(tok) u.searchParams.set('admin', tok); else u.searchParams.delete('admin');
      // Hapus password dari bar browser setelah validasi
      history.replaceState(null,'',u.origin + u.pathname + u.hash);
    }

    async function saveState(state){
      const toSave = { scores: state.scores || {} };
      // 1) Supabase
      if (SUPABASE_ENABLED && SUPABASE) {
        try {
          await SUPABASE.from('scores_state').upsert({ id: 'global', data: toSave }, { onConflict: 'id' });
          return;
        } catch (e) { /* fallthrough */ }
      }
      // 2) Firebase
      if (REMOTE_ENABLED && REMOTE_DB) {
        try { firebase.database().ref(REMOTE_DB).set(toSave); return; } catch (e) { /* fallthrough */ }
      }
      // 3) Local
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify({ scores: toSave.scores })); } catch (e) { /* ignore */ }
      const shareObj = { scores: toSave.scores };
      const h = '#' + encodeURIComponent(JSON.stringify(shareObj));
      const u = new URL(location.href);
      u.hash = h;
      history.replaceState(null, '', u.toString());
    }
    function loadState(){
      // Jika remote (Supabase/Firebase) aktif, listener yang memuat data (async);
      if (SUPABASE_ENABLED || REMOTE_ENABLED) return null;
      try{
        if(location.hash?.length>1){
          const obj = JSON.parse(decodeURIComponent(location.hash.slice(1)));
          if(obj && typeof obj==='object') return { scores: obj.scores || {} };
        }
      }catch(e){/* ignore */}
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(e){return null}
    }

    function clearAdmin(){ localStorage.removeItem(ADMIN_KEY); }

    function hasAdmin() { return localStorage.getItem(ADMIN_KEY) === ADMIN_PASSWORD; }

    // ======= REMOTE (Firebase) =======
    function initRemoteIfConfigured(){
      try{
        if (!window.FIREBASE_CONFIG) return;
        if (!firebase?.apps?.length) firebase.initializeApp(window.FIREBASE_CONFIG);
        const db = firebase.database();
        REMOTE_DB = 'pes_wc/state';
        REMOTE_ENABLED = true;
        db.ref(REMOTE_DB).on('value', (snap)=>{
          const val = snap.val() || { scores:{} };
          const json = JSON.stringify(val);
          if (json === lastRemoteJson) return;
          if (Date.now() - lastLocalSaveAt < 800) return; // ignore echo right after local save
          lastRemoteJson = json;
          state.scores = val.scores || {};
          render();
        });
      }catch(e){
        REMOTE_ENABLED = false;
        REMOTE_DB = null;
      }
    }

    // ======= REMOTE (Supabase) =======
    async function initSupabaseIfConfigured(){
      try{
        const url = window.SUPABASE_URL;
        const anon = window.SUPABASE_ANON_KEY;
        if (!url || !anon || !window.supabase) return;
        SUPABASE = window.supabase.createClient(url, anon, { auth: { persistSession: false } });
        SUPABASE_ENABLED = true;
        // initial load
        const { data, error } = await SUPABASE.from('scores_state').select('data').eq('id','global').maybeSingle();
        if (!error && data?.data) {
          state.scores = data.data.scores || {};
          lastRemoteJson = JSON.stringify({ scores: state.scores });
          render();
        } else if (!error && !data) {
          // seed empty row if not exist so future upserts work consistently
          await SUPABASE.from('scores_state').upsert({ id: 'global', data: { scores: {} } }, { onConflict: 'id' });
        }
        // realtime channel
        SUPABASE_CHANNEL = SUPABASE.channel('scores_state_changes')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'scores_state' }, (payload) => {
            const row = payload.new || payload.old;
            if (!row || row.id !== 'global') return;
            const val = row.data || { scores:{} };
            const json = JSON.stringify(val);
            if (json === lastRemoteJson) return;
            if (Date.now() - lastLocalSaveAt < 800) return; // ignore echo right after local save
            lastRemoteJson = json;
            state.scores = val.scores || {};
            render();
          })
          .subscribe();
      }catch(e){
        SUPABASE_ENABLED = false;
        SUPABASE = null;
      }
    }

    // ======= TIEBREAKERS =======
    function h2hRank(records, fixtures){
      const ids = records.map(r=>r.id);
      const idx = new Map(ids.map((id,i)=>[id,i]));
      const mini = ids.map(()=>({P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,PTS:0}));
      for(const m of fixtures){
        const a = idx.get(m.homeId), b = idx.get(m.awayId);
        if(a===undefined || b===undefined) continue;
        const hs = m.hs, as = m.as;
        if(hs==null || as==null) continue;
        mini[a].P++; mini[b].P++;
        mini[a].GF+=hs; mini[a].GA+=as; mini[a].GD=mini[a].GF-mini[a].GA;
        mini[b].GF+=as; mini[b].GA+=hs; mini[b].GD=mini[b].GF-mini[b].GA;
        if(hs>as){mini[a].W++;mini[b].L++; mini[a].PTS+=3}
        else if(hs<as){mini[b].W++;mini[a].L++; mini[b].PTS+=3}
        else {mini[a].D++;mini[b].D++; mini[a].PTS++; mini[b].PTS++}
      }
      const arr = records.map((r,i)=>({r, m:mini[i]}));
      arr.sort((x,y)=> y.m.PTS - x.m.PTS || y.m.GD - x.m.GD || y.m.GF - x.r.name.localeCompare(y.r.name));
      return arr.map(x=>x.r.id);
    }

    function rankTeams(teams, results){
      const stats = new Map(teams.map(t=>[t.id,{P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,PTS:0}]));
      for(const m of results){
        if(m.hs==null || m.as==null) continue;
        const a = stats.get(m.homeId), b = stats.get(m.awayId);
        a.P++; b.P++;
        a.GF+=m.hs; a.GA+=m.as; a.GD=a.GF-a.GA;
        b.GF+=m.as; b.GA+=m.hs; b.GD=b.GF-b.GA;
        if(m.hs>m.as){a.W++; b.L++; a.PTS+=3}
        else if(m.hs<m.as){b.W++; a.L++; b.PTS+=3}
        else {a.D++; b.D++; a.PTS++; b.PTS++}
      }
      const base = teams.map(t=>({id:t.id, name:t.name, s:stats.get(t.id)}));
      base.sort((x,y)=> y.s.PTS - x.s.PTS || y.s.GD - x.s.GD || y.s.GF - x.s.GF || 0);
      let i=0; while(i<base.length){
        let j=i+1; while(j<base.length && base[j].s.PTS===base[i].s.PTS && base[j].s.GD===base[i].s.GD && base[j].s.GF===base[i].s.GF) j++;
        if(j-i>1){
          const block = base.slice(i,j);
          const orderIds = h2hRank(block, results);
          block.sort((a,b)=> orderIds.indexOf(a.id) - orderIds.indexOf(b.id));
          base.splice(i, j-i, ...block);
        }
        i=j;
      }
      return base;
    }

    // ======= UI RENDER =======
    const tabsEl = document.getElementById('tabs');
    const groupsEl = document.getElementById('groups');
    const summaryEl = document.getElementById('summary');

    // Jika tidak ada state di hash/localStorage, pakai contoh data supaya viewer biasa bisa melihat skor
    // Mulai tanpa skor jika belum ada data sehingga pengunjung melihat layar kosong
    // (Jika mau preload contoh untuk testing, kembalikan DEFAULT_SCORES dan gunakan di bawah)
    const state = loadState() || { scores: {} };

    const groups = {};

    function makeTeamLabel(p){
      // Pisahkan bendera dari nama tim jika ada
      const match = p.team.match(/(.*?)([\u{1F1E6}-\u{1F1FF}]{2,}|ðŸ´)?$/u);
      let teamName = match ? match[1].trim() : p.team;
      let flag = match ? match[2] || '' : '';
      // Gunakan NBSP sebelum bendera agar tidak turun ke baris berikutnya
      const nbsp = "\u00A0";
      const countryWithFlag = flag ? `${capitalizeWords(teamName)}${nbsp}${flag}` : capitalizeWords(teamName);
      return `${capitalizeWords(p.name)} â€” ${countryWithFlag}`.trim();
    }

    function buildFixtures(arr){
      // Home-away round robin (6 matches)
      return [
        [0,1,true], [1,0,true],
        [0,2,true], [2,0,true],
        [1,2,true], [2,1,true]
      ];
    }

    function render(){
      tabsEl.innerHTML = '';
      groupsEl.innerHTML = '';
      summaryEl.innerHTML = '';

      const isAdmin = hasAdmin();

      // Tampilkan tombol reset & exit hanya untuk admin; tombol masuk untuk non-admin
      document.getElementById('btnReset').style.display = isAdmin ? '' : 'none';
      document.getElementById('btnExitAdmin').style.display = isAdmin ? '' : 'none';
      document.getElementById('btnEnterAdmin').style.display = isAdmin ? 'none' : '';

      Object.entries(GROUPS).forEach(([grp, players], idx)=>{
        // Tabs
        const tab = document.createElement('button');
        tab.className = `px-3 py-2 rounded-xl card text-sm ${idx===0? 'tab-active':''}`;
        tab.textContent = `Grup ${grp}`;
        tab.addEventListener('click',()=>{
          document.querySelectorAll('#tabs > button').forEach(b=>b.classList.remove('tab-active'));
          tab.classList.add('tab-active');
          document.querySelectorAll('[data-group]')
            .forEach(sec=>sec.classList.toggle('hidden', sec.getAttribute('data-group')!==grp));
        });
        tabsEl.appendChild(tab);

        // Section
        const gtpl = document.getElementById('groupTemplate');
        const node = gtpl.content.cloneNode(true);
        const section = node.querySelector('section');
        section.setAttribute('data-group', grp);
        if(idx!==0) section.classList.add('hidden');
        section.querySelector('.grp-name').textContent = grp;

        if(!isAdmin){
          const lb = document.createElement('div');
          lb.className = 'lock-badge text-slate-300 mb-2';
          lb.innerHTML = 'ðŸ”’ mode viewer Â· hanya admin yang bisa input skor';
          section.prepend(lb);
          section.classList.add('locked');
        }

        // Build team objects w/ ids
        const teams = players.map((p,i)=>({ id:`${grp}-${i}`, name: makeTeamLabel(p) }));
        const nameById = Object.fromEntries(teams.map(t=>[t.id,t.name]));

        // Matches
        const matchesWrap = section.querySelector('.matches');
        const mtpl = document.getElementById('matchTemplate');
        const pairs = buildFixtures(players);
        section.querySelector('.total-matches').textContent = pairs.length;

        pairs.forEach((pair, i)=>{
          const [a,b] = pair;
          const mnode = mtpl.content.cloneNode(true);
          mnode.querySelector('.md-no').textContent = (i+1);
          const k = keyFor(grp,a,b);
          const hsInput = mnode.querySelector('.home-score');
          const asInput = mnode.querySelector('.away-score');
          const swapBtn = mnode.querySelector('.swap-btn'); // may be null in current template

          // Home/away mapping
          const homeId = `${grp}-${a}`;
          const awayId = `${grp}-${b}`;
          const saved = state.scores[k] || null;

          mnode.querySelector('.home').textContent = nameById[homeId];
          mnode.querySelector('.away').textContent = nameById[awayId];
          if(saved){
            if(saved.hs!=null) hsInput.value = saved.hs;
            if(saved.as!=null) asInput.value = saved.as;
          }

          function persistFromInputs(){
            const hs = hsInput.value===''? null : parseInt(hsInput.value,10);
            const as = asInput.value===''? null : parseInt(asInput.value,10);
            state.scores[k] = { hs, as, homeId, awayId };
            scheduleSave();
            updateStandings();
          }

          hsInput.addEventListener('input', persistFromInputs);
          asInput.addEventListener('input', persistFromInputs);

          if(!isAdmin){
            hsInput.disabled = true;
            asInput.disabled = true;
            if(swapBtn) swapBtn.style.display = 'none';
          }

          matchesWrap.appendChild(mnode);
        });

        const tbody = section.querySelector('.standings');
        function drawStandings(){
          const rows = rankTeams(teams, collectResultsForGroup(grp));
          tbody.innerHTML='';
          rows.forEach(r=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="text-left">${r.name}</td>
              <td class="text-center">${r.s.P}</td>
              <td class="text-center">${r.s.W}</td>
              <td class="text-center">${r.s.D}</td>
              <td class="text-center">${r.s.L}</td>
              <td class="text-center">${r.s.GF}</td>
              <td class="text-center">${r.s.GA}</td>
              <td class="text-center">${r.s.GD}</td>
              <td class="text-center font-semibold">${r.s.PTS}</td>
            `;
            tbody.appendChild(tr);
          })
        }
        groups[grp] = { drawStandings, teams };

        groupsEl.appendChild(node);
      });

      updateStandings();
      if (window.twemoji) applyEmoji();
    }

    function keyFor(grp,a,b){return `${grp}-${a}-${b}`}

    function collectResultsForGroup(grp){
      const players = GROUPS[grp];
      const pairs = buildFixtures(players);
      const out=[];
      pairs.forEach(([a,b])=>{
        const k = keyFor(grp,a,b);
        const saved = state.scores[k] || null;
        const homeId = `${grp}-${a}`;
        const awayId = `${grp}-${b}`;
        out.push({ homeId, awayId, hs: saved?.hs ?? null, as: saved?.as ?? null });
      });
      return out;
    }
    function scheduleSave(){
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(async ()=>{
        lastLocalSaveAt = Date.now();
        await saveState(state);
      }, 500);
    }
    //
    function updateStandings(){
      Object.keys(GROUPS).forEach(grp=>{ groups[grp]?.drawStandings(); });
      summaryEl.innerHTML='';
      Object.entries(groups).forEach(([grp, g])=>{
        const rows = rankTeams(g.teams, collectResultsForGroup(grp));
        const top = rows.slice(0,2);
        const div = document.createElement('div');
        div.className = 'rounded-xl p-4 card';
        div.innerHTML = `
          <div class=\"flex items-center justify-between mb-2\">
            <div class=\"font-semibold\">Grup ${grp}</div>
            <div class=\"text-xs text-slate-400\">${rows.reduce((p,c)=>p+(c.s.PTS||0),0)} total pts</div>
          </div>
          <ol class=\"space-y-1 text-sm\">
            ${top.map((t,i)=>`<li class=\"flex items-center justify-between\"><span>${i+1}. ${t.name}</span><span class=\"badge\">${t.s.PTS} pts | GD ${t.s.GD}</span></li>`).join('')}
          </ol>`;
        summaryEl.appendChild(div);
      });
      if (window.twemoji) applyEmoji();
    }

    // ======= Buttons =======
    document.getElementById('btnEnterAdmin').addEventListener('click',()=>{
      const v = prompt('Masukkan password admin:');
      if(!v) return;
      if (v.trim() === ADMIN_PASSWORD) {
        localStorage.setItem(ADMIN_KEY, ADMIN_PASSWORD);
        toast('Admin mode diaktifkan');
        location.reload();
      } else {
        toast('Password salah');
      }
    });

    document.getElementById('btnReset').addEventListener('click',()=>{
      if(!confirm('Hapus semua skor?')) return;
      state.scores = {};
      saveState(state);
      location.reload();
    });

    document.getElementById('btnExitAdmin').addEventListener('click',()=>{
      clearAdmin();
      toast('Admin dimatikan');
      location.reload();
    });

    function toast(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      el.className = 'fixed left-1/2 -translate-x-1/2 bottom-6 px-4 py-2 rounded-xl card text-sm';
      document.body.appendChild(el);
      setTimeout(()=>{el.remove()}, 2200);
    }

    function capitalizeWords(str) {
      return str.replace(/\b\w/g, l => l.toUpperCase());
    }

    function applyEmoji(){
      try{
        window.twemoji.parse(document.body, { folder: 'svg', ext: '.svg', className: 'emoji' });
      }catch(e){/* ignore */}
    }

    (function init(){
      // Jika ada token di URL, hasAdmin() akan menyimpannya ke localStorage.
      initSupabaseIfConfigured();
      initRemoteIfConfigured();
      render();
    })();
  </script>
</body>
</html>
